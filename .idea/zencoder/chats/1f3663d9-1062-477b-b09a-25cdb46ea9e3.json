{
    "checksum": "07f080abac9d9dc688b38a77f6711f3708862eb7161245279863960c62751b56",
    "data": {
    "id": "1f3663d9-1062-477b-b09a-25cdb46ea9e3",
    "createdAt": 1750349948173,
    "updatedAt": 1750349948175,
    "title": "2025-06-19 17:17:32 error: [CRITICAL] bot.catch...",
    "messages": [
        {
            "id": "e1152361-bce2-4041-a5a6-0803aba5c5cd",
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": "2025-06-19 17:17:32 error: [CRITICAL] bot.catch is not a function"
                },
                {
                    "type": "text",
                    "text": "TypeError: bot.catch is not a function"
                },
                {
                    "type": "text",
                    "text": "    at setupEventHandlers (file:///C:/Users/johan/Scory-bot/src/app.js:94:12)"
                },
                {
                    "type": "text",
                    "text": "    at startApp (file:///C:/Users/johan/Scory-bot/src/app.js:43:5)"
                },
                {
                    "type": "text",
                    "text": "Impossible d'envoyer la notification d'erreur: TypeError: Cannot read properties of undefined (reading 'sendMessage')"
                },
                {
                    "type": "text",
                    "text": "    at startApp (file:///C:/Users/johan/Scory-bot/src/app.js:67:26)"
                }
            ],
            "context": {
                "currentFile": {
                    "path": "src\\app.js",
                    "fsPath": "C:\\Users\\johan\\Scory-bot\\src\\app.js",
                    "sources": [
                        "opened_tab"
                    ],
                    "content": "import dotenv from 'dotenv';\nimport { fileURLToPath } from 'url';\nimport path from 'path';\nimport { setupCommands } from './commands/index.js';\nimport { bot, setupBot } from './config/bot.js';\nimport { connectToDatabase } from './config/database.js';\nimport { TELEGRAM_CONFIG, ENV_CONFIG } from './config/telegram.js';\nimport logger, { logCriticalError, logUserAction } from './utils/logger.js';\n\n// Charger les variables d'environnement\ndotenv.config();\n\n// Configuration bas√©e sur l'environnement\nconst env = process.env.NODE_ENV || 'development';\nconst config = {\n  ...TELEGRAM_CONFIG,\n  ...(ENV_CONFIG[env] || ENV_CONFIG.development)\n};\n\n// Obtenir le chemin du r√©pertoire actuel\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n/**\n * Fonction principale pour d√©marrer l'application\n */\nasync function startApp() {\n  try {\n    // 1. Connexion √† la base de donn√©es\n    logger.info('Connexion √† la base de donn√©es...');\n    await connectToDatabase();\n    logger.info('‚úÖ Base de donn√©es connect√©e avec succ√®s');\n\n    // 2. Configuration du bot\n    logger.info('Configuration du bot...');\n    await setupBot();\n    \n    // 3. Configuration des commandes\n    logger.info('Configuration des commandes...');\n    await setupCommands();\n    \n    // 4. Configuration des gestionnaires d'√©v√©nements\n    setupEventHandlers();\n    \n    // 5. D√©marrer le bot en mode polling ou webhook selon la configuration\n    if (config.polling) {\n      logger.info('D√©marrage du bot en mode polling...');\n      await bot.startPolling(config.POLLING_OPTIONS);\n    } else if (config.webhook) {\n      logger.info('D√©marrage du bot en mode webhook...');\n      await bot.launch({\n        webhook: config.WEBHOOK_OPTIONS\n      });\n    }\n    \n    logger.info(`ü§ñ Bot d√©marr√© avec succ√®s en mode ${env.toUpperCase()}`);\n    \n  } catch (error) {\n    const errorMsg = `√âchec du d√©marrage de l'application: ${error.message}`;\n    logCriticalError(error, { \n      context: 'D√©marrage de l\\'application',\n      stack: error.stack \n    });\n    \n    // Essayer d'envoyer un message d'erreur avant de quitter\n    try {\n      await bot.telegram.sendMessage(\n        process.env.ADMIN_CHAT_ID, \n        `‚ùå Erreur critique: ${error.message}\\n\\nStack: ${error.stack}`.substring(0, 4000)\n      );\n    } catch (e) {\n      console.error('Impossible d\\'envoyer la notification d\\'erreur:', e);\n    }\n    \n    process.exit(1);\n  }\n}\n\n/**\n * Configure les gestionnaires d'√©v√©nements du bot\n */\nfunction setupEventHandlers() {\n  // Gestion des erreurs de polling\n  bot.on('polling_error', (error) => {\n    logCriticalError(error, { context: 'Erreur de polling' });\n  });\n  \n  // Gestion des erreurs de webhook\n  bot.on('webhook_error', (error) => {\n    logCriticalError(error, { context: 'Erreur de webhook' });\n  });\n  \n  // Gestion des erreurs g√©n√©rales du bot\n  bot.catch((error) => {\n    logCriticalError(error, { context: 'Erreur non g√©r√©e du bot' });\n  });\n  \n  // Log des messages entrants (pour d√©bogage)\n  if (env !== 'production') {\n    bot.on('message', (ctx) => {\n      const { from, chat, text } = ctx.message || {};\n      const userId = from?.id;\n      const userName = from?.username || `${from?.first_name || ''} ${from?.last_name || ''}`.trim();\n      const chatType = chat?.type || 'unknown';\n      \n      logger.debug(`[${chatType}] ${userName} (${userId}): ${text || '[sans texte]'}`);\n    });\n  }\n}\n\n/**\n * Gestion propre de l'arr√™t de l'application\n */\nasync function shutdown(signal) {\n  logger.warn(`Signal ${signal} re√ßu. Arr√™t en cours...`);\n  \n  try {\n    logger.info('Arr√™t du bot...');\n    await bot.stop();\n    logger.info('‚úÖ Bot arr√™t√© avec succ√®s');\n    \n    // Fermer les connexions √† la base de donn√©es si n√©cessaire\n    // await mongoose.connection.close();\n    \n    logger.info('‚úÖ Arr√™t termin√©');\n    process.exit(0);\n  } catch (error) {\n    logCriticalError(error, { context: 'Erreur lors de l\\'arr√™t' });\n    process.exit(1);\n  }\n}\n\n// Gestion des signaux d'arr√™t\nprocess.once('SIGINT', () => shutdown('SIGINT'));\nprocess.once('SIGTERM', () => shutdown('SIGTERM'));\n\n// Gestion des erreurs non captur√©es\nprocess.on('unhandledRejection', (reason, promise) => {\n  const errorMsg = 'UNHANDLED REJECTION';\n  logger.error(errorMsg, { \n    reason: reason?.message || reason, \n    stack: reason?.stack,\n    promise \n  });\n  \n  // En production, on peut notifier l'administrateur\n  if (process.env.NODE_ENV === 'production') {\n    bot.telegram.sendMessage(\n      process.env.ADMIN_CHAT_ID, \n      `${errorMsg}: ${reason?.message || 'Aucun d√©tail'}`\n    ).catch(console.error);\n  }\n});\n\nprocess.on('uncaughtException', (error) => {\n  logCriticalError(error, { context: 'UNCAUGHT EXCEPTION' });\n  \n  // On laisse le processus se terminer apr√®s une erreur non captur√©e\n  // (selon les bonnes pratiques Node.js)\n  process.exit(1);\n});\n\n// D√©marrer l'application\nstartApp();"
                },
                "codebaseEnabled": true
            },
            "createdAt": 1750349948175,
            "isInternal": false,
            "rawContent": {
                "type": "doc",
                "content": [
                    {
                        "type": "paragraph",
                        "content": [
                            {
                                "type": "text",
                                "text": "2025-06-19 17:17:32 error: [CRITICAL] bot.catch is not a function"
                            }
                        ]
                    },
                    {
                        "type": "paragraph",
                        "content": [
                            {
                                "type": "text",
                                "text": "TypeError: bot.catch is not a function"
                            }
                        ]
                    },
                    {
                        "type": "paragraph",
                        "content": [
                            {
                                "type": "text",
                                "text": "    at setupEventHandlers (file:///C:/Users/johan/Scory-bot/src/app.js:94:12)"
                            }
                        ]
                    },
                    {
                        "type": "paragraph",
                        "content": [
                            {
                                "type": "text",
                                "text": "    at startApp (file:///C:/Users/johan/Scory-bot/src/app.js:43:5)"
                            }
                        ]
                    },
                    {
                        "type": "paragraph",
                        "content": [
                            {
                                "type": "text",
                                "text": "Impossible d'envoyer la notification d'erreur: TypeError: Cannot read properties of undefined (reading 'sendMessage')"
                            }
                        ]
                    },
                    {
                        "type": "paragraph",
                        "content": [
                            {
                                "type": "text",
                                "text": "    at startApp (file:///C:/Users/johan/Scory-bot/src/app.js:67:26)"
                            }
                        ]
                    },
                    {
                        "type": "paragraph"
                    }
                ]
            }
        }
    ],
    "isAgent": true,
    "isCustomAgent": false,
    "isUnitTestsAgent": false,
    "isE2EAgent": false,
    "autoApply": false
}
}